FROM ubuntu:20.04

# Note: libindy is a dependency for tests, and it's easiest to install on ubuntu images 
# using debian from python base images doesn't allow following steps to work, so build from ubuntu:20

# Install basic dependencies
RUN apt-get update && apt-get install -y ca-certificates gnupg software-properties-common wget curl

# Install libindy directly from GitHub releases (definitive solution)
RUN wget -q https://github.com/hyperledger/indy-sdk/releases/download/v1.16.0/libindy_1.16.0_amd64.deb -O /tmp/libindy.deb && \
    dpkg -i /tmp/libindy.deb || (apt-get update && apt-get install -f -y && dpkg -i /tmp/libindy.deb) && \
    rm /tmp/libindy.deb || echo "libindy installation failed, continuing with python3_indy"

# Install Python 3.9 and python3-pip
RUN apt-get install -y python3.9 python3.9-venv python3.9-dev python3-pip

ADD requirements.txt .
ADD requirements.dev.txt .

# Upgrade pip using Python 3.9 to ensure compatibility
RUN python3.9 -m pip install --upgrade pip

# Use Python 3.9's pip to install dependencies from requirements files
RUN python3.9 -m pip install --no-cache-dir -r requirements.txt -r requirements.dev.txt

# Set up environment for libindy and update library cache
RUN echo 'export LD_LIBRARY_PATH=/usr/local/lib:/usr/lib/x86_64-linux-gnu:/usr/lib:/usr/lib:$LD_LIBRARY_PATH' >> /etc/environment && \
    echo 'export LD_LIBRARY_PATH=/usr/local/lib:/usr/lib/x86_64-linux-gnu:/usr/lib:/usr/lib:$LD_LIBRARY_PATH' >> /root/.bashrc && \
    ldconfig

ADD test ./

ENTRYPOINT ["python3.9", "integration.py"]